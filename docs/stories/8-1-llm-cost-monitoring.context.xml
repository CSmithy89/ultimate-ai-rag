<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>8.1</story-id>
    <story-name>LLM Cost Monitoring</story-name>
    <epic>Epic 8: Operations &amp; Observability</epic>
    <status>ready-for-dev</status>
    <generated>2025-12-31</generated>
    <depends-on>Epic 2 trajectory logging, Epic 7 routing infrastructure</depends-on>
  </metadata>

  <summary>
    <description>
      Implement persistent LLM usage tracking with per-request token counts, model pricing,
      and tenant-level aggregation. Expose ops endpoints for cost summaries, event lists,
      and alert thresholds. Surface the data in an Ops dashboard.
    </description>
    <user-story>
      As an ops engineer,
      I want to monitor real-time LLM interaction costs,
      so that I can track spending and identify optimization opportunities.
    </user-story>
  </summary>

  <acceptance-criteria>
    <criterion id="AC1">
      Given the system is processing LLM requests, when an ops engineer views the cost dashboard,
      then they see real-time token usage per request.
    </criterion>
    <criterion id="AC2">
      Given costs are calculated, when a request completes, then costs are derived from model pricing
      (input + output tokens).
    </criterion>
    <criterion id="AC3">
      Given usage is stored, when a tenant is selected, then usage is aggregated by tenant (NFR3).
    </criterion>
    <criterion id="AC4">
      Given historical data exists, when the ops dashboard loads, then historical cost trends
      are displayed.
    </criterion>
    <criterion id="AC5">
      Given alerts are configured, when spending crosses thresholds, then alerts are surfaced
      in the dashboard.
    </criterion>
  </acceptance-criteria>

  <architecture-decisions>
    <decision id="AD1" category="storage">
      <title>Usage Events in Postgres</title>
      <description>
        Persist LLM usage in a dedicated `llm_usage_events` table with tenant_id, model_id,
        token counts, and computed costs. Index on tenant_id + created_at for aggregation.
      </description>
    </decision>
    <decision id="AD2" category="pricing">
      <title>Configurable Pricing Map</title>
      <description>
        Pricing per model is loaded from environment configuration (JSON) with defaults
        for gpt-4o-mini and gpt-4o. Token counts are estimated via tiktoken.
      </description>
    </decision>
    <decision id="AD3" category="ops-api">
      <title>Ops Cost Endpoints</title>
      <description>
        Add GET endpoints for summary and event list plus POST/GET for alert thresholds.
        All endpoints require tenant_id and enforce tenant filtering.
      </description>
    </decision>
  </architecture-decisions>

  <technology-stack>
    <technology name="FastAPI" purpose="Ops API endpoints"/>
    <technology name="PostgreSQL" purpose="Usage event storage and aggregation"/>
    <technology name="tiktoken" purpose="Token estimation for prompts and responses"/>
    <technology name="TanStack Query" purpose="Frontend data fetching"/>
    <technology name="Next.js" purpose="Ops dashboard UI"/>
  </technology-stack>

  <database-schema>
    <postgresql>
      <table name="llm_usage_events">
        <description>LLM usage events with token and cost metrics</description>
        <sql>
          <![CDATA[
CREATE TABLE IF NOT EXISTS llm_usage_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id TEXT NOT NULL,
    trajectory_id UUID,
    model_id TEXT NOT NULL,
    prompt_tokens INTEGER NOT NULL,
    completion_tokens INTEGER NOT NULL,
    total_tokens INTEGER NOT NULL,
    input_cost_usd NUMERIC(12, 6) NOT NULL,
    output_cost_usd NUMERIC(12, 6) NOT NULL,
    total_cost_usd NUMERIC(12, 6) NOT NULL,
    complexity TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
          ]]>
        </sql>
      </table>
      <table name="llm_cost_alerts">
        <description>Per-tenant alert thresholds</description>
        <sql>
          <![CDATA[
CREATE TABLE IF NOT EXISTS llm_cost_alerts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id TEXT NOT NULL,
    daily_threshold_usd NUMERIC(12, 2),
    monthly_threshold_usd NUMERIC(12, 2),
    enabled BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
          ]]>
        </sql>
      </table>
    </postgresql>
  </database-schema>

  <api-contracts>
    <endpoint>
      <method>GET</method>
      <path>/api/v1/ops/costs/summary</path>
      <notes>Returns aggregated cost metrics for a tenant and time window.</notes>
    </endpoint>
    <endpoint>
      <method>GET</method>
      <path>/api/v1/ops/costs/events</path>
      <notes>Returns latest usage events per request.</notes>
    </endpoint>
    <endpoint>
      <method>POST</method>
      <path>/api/v1/ops/costs/alerts</path>
      <notes>Configure spending thresholds for alerts.</notes>
    </endpoint>
  </api-contracts>

  <implementation-notes>
    <note>
      Use `backend/src/agentic_rag_backend/ops/cost_tracker.py` to keep cost calculations
      isolated and testable.
    </note>
    <note>
      Frontend dashboard should be in `frontend/app/ops/page.tsx` with
      TanStack Query hooks under `frontend/hooks/use-ops-dashboard.ts`.
    </note>
  </implementation-notes>

  <references>
    <reference path="docs/epics/epic-8-tech-spec.md"/>
    <reference path="_bmad-output/project-planning-artifacts/epics.md#story-81-llm-cost-monitoring"/>
    <reference path="backend/src/agentic_rag_backend/main.py"/>
    <reference path="backend/src/agentic_rag_backend/agents/orchestrator.py"/>
  </references>
</story-context>
