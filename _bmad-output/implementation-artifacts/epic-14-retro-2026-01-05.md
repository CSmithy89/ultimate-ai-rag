# Epic 14 Retrospective: Connectivity (MCP Wrapper Architecture)

**Date:** 2026-01-05
**Facilitator:** Claude Opus 4.5
**Mode:** YOLO (Automated Analysis)
**Duration:** 2 days actual (4 days estimated for Story 14-1, 5-6 days estimated for Story 14-2)

---

## Executive Summary

Epic 14 successfully delivered two major connectivity protocols that position the Agentic RAG platform for external integration:

1. **Story 14-1: MCP Server** - Exposes RAG engine via Model Context Protocol for Claude Desktop, Cursor, VS Code integration
2. **Story 14-2: A2A Protocol** - Implements Google's Agent-to-Agent protocol for multi-agent orchestration

**PR #16** merged with 5,776 additions across 18 changed files. Both stories underwent adversarial code reviews with multiple rounds of fixes.

---

## Stories Delivered

| Story | Title                              | Estimated  | Actual  | Tests      | Code Review          |
|-------|------------------------------------|------------|---------|------------|----------------------|
| 14-1  | Expose RAG Engine via MCP Server   | 5-6 days   | ~1 day  | 89 passing | 2 rounds, APPROVED   |
| 14-2  | Implement Robust A2A Protocol      | 5-6 days   | ~1 day  | 75 passing | 2 rounds, APPROVED   |

**Total:** 164 unit tests passing (89 MCP + 75 A2A)

---

## What Went Well

### 1. Strong Architectural Decisions

- **MCP Wrapper Pattern**: Decision to WRAP Graphiti MCP rather than duplicate was excellent. This follows DRY principle and ensures Graphiti updates flow through automatically.
- **Separate Concerns**: Clean module separation (`a2a_messages.py`, `a2a_registry.py`, `a2a_delegation.py`) made code review and testing straightforward.
- **Redis Fallback**: All Redis operations gracefully degrade to in-memory storage, preventing single points of failure.

### 2. Effective Code Review Process

The adversarial code review methodology caught critical issues before merge:

**Story 14-1 (MCP):**

- 8 findings identified, all fixed
- HIGH: Tenant isolation gap in `get_node`/`get_edges` - could have allowed cross-tenant data access
- HIGH: Missing cross-tenant validation in registry

**Story 14-2 (A2A):**

- 10 findings identified, 6 required fixes
- HIGH: Missing tenant isolation in `get_task_status` result loading
- HIGH: No self-registration at startup (defeated capability discovery purpose)
- MEDIUM: Heartbeat endpoint path mismatch with spec

### 3. Thorough Test Coverage

- **MCP Server**: 89 tests covering types, auth, rate limiting, registry, server, and tools
- **A2A Protocol**: 75 tests covering messages, registry, delegation, concurrent tasks
- Tests properly mock Redis and external HTTP calls

### 4. Documentation Quality

- Clear `.env.example` entries with explanatory comments
- API endpoint documentation in story files
- Client configuration examples for Claude Desktop and Cursor IDE

### 5. Multi-Round Fix Commits

Six fix commits demonstrate iterative improvement:

```text
0f13baf Docs: Add repository guidelines for AI agents
e509975 Fix: Address final code review findings
6fb7c5c Fix: Address third round of code review findings
cd3b6e3 Fix: Address additional code review findings for A2A
38b0347 Refactor: Address LOW priority code review findings for A2A
d44c4ce Fix: Address code review findings for A2A protocol
```

---

## What Went Wrong

### 1. Initial Implementation Gaps

**Tenant Isolation Oversights:**

- Both stories initially had tenant isolation gaps that required code review to catch
- MCP `get_node`/`get_edges` tools didn't verify `group_id` matched tenant
- A2A `get_task_status` didn't verify tenant when loading from Redis

**Lesson:** Security boundaries (especially multi-tenancy) need explicit checklist items in story acceptance criteria.

### 2. Spec vs Implementation Mismatches

- A2A heartbeat endpoint used different path than story spec (`/agents/heartbeat` vs `/agents/{agent_id}/heartbeat`)
- Capability advertisement included 6 capabilities but only 2 were implemented in execute endpoint

**Lesson:** Story acceptance criteria should be checked mechanically, not assumed.

### 3. Missing Self-Registration

Story 14-2 required this agent to register its own capabilities at startup, but initial implementation didn't include the `register_self()` call. This defeated the entire purpose of capability discovery.

**Lesson:** "Integration with main.py" should be a separate task with explicit verification.

### 4. Error Handling Inconsistencies

- Some A2A endpoints returned raw error strings instead of RFC 7807 format
- Missing `A2A_AGENT_UNHEALTHY` error code (specified in context file but not implemented)

**Lesson:** Error handling patterns should be enforced via linting or pre-commit hooks.

---

## Technical Debt Created

### 1. Integration Tests Deferred

**Item:** Task 6.4 (A2A API endpoint integration tests) deferred to Epic 19
**Location:** Story 14-2, Definition of Done
**Risk:** LOW - Unit tests provide good coverage; integration infrastructure exists from Epic 10
**Recommendation:** Add to Epic 19-F2 (multi-tenancy enforcement tests)
**Status:** TRACKED - Added note to 19-F2 in sprint-status.yaml

### 2. Hardcoded Timeout Values (Fixed)

**Item:** `ingest_url` (120s) and `ingest_youtube` (60s) had hardcoded timeouts
**Status:** FIXED - Now configurable via `_get_tool_timeout()` helper
**No action needed**

### 3. PDF Ingestion Uses Text Ingestion Flow

**Item:** `ingest_pdf` mentioned in requirements uses same flow as `ingest_text`
**Location:** Story 14-1 AC-7
**Risk:** LOW - Functional but not optimized for PDF-specific features
**Recommendation:** Consider dedicated PDF parsing tool with Docling in future epic
**Status:** TRACKED - Added as 19-J3-implement-dedicated-pdf-parsing-tool in sprint-status.yaml

### 4. stdio Transport Not Implemented

**Item:** MCP stdio transport for Claude Desktop integration (CLI mode) not implemented
**Location:** Story 14-1 Future Enhancements
**Risk:** MEDIUM - Limits Claude Desktop native integration
**Recommendation:** Add to Epic 18 or new connectivity epic
**Status:** TRACKED - Added as 18-10-implement-mcp-stdio-transport in sprint-status.yaml

---

## Recommendations for Future Epics

### 1. Security-First Development

- Add "Tenant Isolation Verification" as explicit acceptance criterion for all data-access operations
- Create automated security test suite that attempts cross-tenant access patterns
- Consider adding tenant_id to Redis key structure (not just values) for defense-in-depth

### 2. Spec Compliance Automation

- Create endpoint path validation tests that compare actual routes to story specs
- Add capability inventory tests that verify advertised capabilities match implemented ones
- Consider OpenAPI spec generation from story acceptance criteria

### 3. Code Review Efficiency

- Pre-populate code review checklists from story context files
- Create "new-code-patterns" memory files for reusable review criteria
- Consider parallel code reviews to catch different issue types

### 4. Error Handling Standards

- Create RFC 7807 error response linter
- Add error code completeness check to CI
- Document error code naming conventions in AGENTS.md

### 5. Protocol Compliance Testing

- Add A2A protocol compliance test suite (Google provides spec)
- Add MCP protocol compliance test suite
- Consider contract testing with Pact or similar

---

## Metrics

### Code Statistics

| Metric                   | Value              |
|--------------------------|--------------------|
| Lines Added              | 5,776              |
| Files Changed            | 18                 |
| New Test Files           | 8 (5 MCP + 3 A2A)  |
| New Implementation Files | 14                 |
| Config Variables Added   | 7 (A2A)            |

### Review Statistics

| Metric           | Story 14-1 | Story 14-2 |
|------------------|------------|------------|
| Initial Findings | 8          | 10         |
| HIGH Severity    | 2          | 2          |
| MEDIUM Severity  | 2          | 4          |
| LOW Severity     | 4          | 4          |
| Review Rounds    | 2          | 2          |
| Fix Commits      | 2          | 4          |

### API Endpoints Added

**MCP Server (7 endpoints):**

- `GET /mcp/v1/tools`
- `POST /mcp/v1/tools/call`
- `POST /mcp/v1/jsonrpc`
- `GET /mcp/v1/sse`
- `POST /mcp/v1/sse/send`
- `GET /mcp/v1/info`
- `GET /mcp/v1/health`

**A2A Protocol (9 endpoints):**

- `POST /a2a/agents/register`
- `POST /a2a/agents/{agent_id}/heartbeat`
- `GET /a2a/agents`
- `DELETE /a2a/agents/{agent_id}`
- `GET /a2a/capabilities`
- `POST /a2a/tasks/delegate`
- `GET /a2a/tasks/{task_id}/result`
- `DELETE /a2a/tasks/{task_id}`
- `POST /a2a/execute`

---

## Action Items

### For Epic 16+ (Future Development)

| Item                                       | Priority | Owner | Target          | Status    |
|--------------------------------------------|----------|-------|-----------------|-----------|
| Add A2A integration tests to Epic 19-F2    | MEDIUM   | Dev   | Epic 19         | TRACKED   |
| Implement stdio transport for MCP          | MEDIUM   | Dev   | Epic 18         | TRACKED   |
| Add tenant isolation automated tests       | HIGH     | Dev   | Epic 19         | TRACKED   |
| Create endpoint spec compliance tests      | MEDIUM   | Dev   | Epic 19         | TRACKED   |

**Notes:**

- A2A integration tests noted in 19-F2 description
- stdio transport tracked as 18-10-implement-mcp-stdio-transport
- Tenant isolation tracked as 19-J1-add-tenant-isolation-automated-tests
- Spec compliance tracked as 19-J2-add-endpoint-spec-compliance-tests

### For Process Improvement

| Item                                         | Priority | Owner | Target                     | Status    |
|----------------------------------------------|----------|-------|----------------------------|-----------|
| Add security checklist to story template     | HIGH     | SM    | Immediate                  | DONE      |
| Create RFC 7807 linter rule                  | MEDIUM   | Dev   | Epic 18                    | TRACKED   |
| Document error code conventions in AGENTS.md | LOW      | Dev   | Done (added in this epic)  | DONE      |

**Notes:**

- Security checklist added to `docs/stories/_template.md`
- RFC 7807 linter tracked as `18-11-implement-rfc7807-linter-rule` in sprint-status.yaml
- Error code conventions documented in `AGENTS.md`

---

## Conclusion

Epic 14 was a success. Both stories delivered working, tested implementations of industry-standard protocols (MCP and A2A). The adversarial code review process proved its value by catching critical security issues that would have allowed cross-tenant data access.

The key learning is that multi-tenancy enforcement needs to be treated as a first-class concern with explicit verification, not assumed from good intentions. The pattern of "check tenant_id after fetching data, not just in the query" emerged as important for defense-in-depth.

The platform is now ready for external integrations with Claude Desktop, Cursor, VS Code (via MCP), and multi-agent orchestration systems (via A2A).

---

### Retrospective Metadata

Retrospective completed in YOLO mode by Claude Opus 4.5
