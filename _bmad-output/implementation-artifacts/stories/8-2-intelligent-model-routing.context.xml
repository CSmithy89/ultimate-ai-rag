<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>8.2</story-id>
    <story-name>Intelligent Model Routing</story-name>
    <epic>Epic 8: Operations &amp; Observability</epic>
    <status>ready-for-dev</status>
    <generated>2025-12-31</generated>
    <depends-on>Story 8.1 (LLM Cost Monitoring)</depends-on>
  </metadata>

  <summary>
    <description>
      Implement an explainable model router that scores query complexity and selects
      an LLM model based on configurable thresholds and mapping. Integrate routing
      into the orchestrator, log decisions in trajectories, and track cost savings.
    </description>
    <user-story>
      As an ops engineer,
      I want the system to route queries to different LLM models based on complexity,
      so that simple queries use cheaper models while complex ones get premium models.
    </user-story>
  </summary>

  <acceptance-criteria>
    <criterion id="AC1">
      Given a query is submitted, when routing logic evaluates it, then it classifies
      complexity (simple, medium, complex).
    </criterion>
    <criterion id="AC2">
      Given a simple query, when routing occurs, then it uses a cost-effective model.
    </criterion>
    <criterion id="AC3">
      Given a complex query, when routing occurs, then it uses a premium model.
    </criterion>
    <criterion id="AC4">
      Given routing configuration exists, when ops changes settings, then routing
      follows the configured thresholds and model mapping.
    </criterion>
    <criterion id="AC5">
      Given routing occurs, when a request completes, then the routing decision
      is logged in the trajectory.
    </criterion>
    <criterion id="AC6">
      Given cost tracking is enabled, when routing uses cheaper models, then
      cost savings are tracked and reported.
    </criterion>
  </acceptance-criteria>

  <architecture-decisions>
    <decision id="AD1" category="routing">
      <title>Deterministic Complexity Scoring</title>
      <description>
        Use a deterministic scoring system based on token count and keyword heuristics.
        Map scores to simple/medium/complex using configurable thresholds.
      </description>
    </decision>
    <decision id="AD2" category="config">
      <title>Env-configurable Model Mapping</title>
      <description>
        Define routing settings via env variables for model IDs and thresholds.
      </description>
    </decision>
    <decision id="AD3" category="savings">
      <title>Baseline Cost Comparison</title>
      <description>
        Calculate savings by comparing selected model cost against a configurable
        baseline (premium) model for each request.
      </description>
    </decision>
  </architecture-decisions>

  <technology-stack>
    <technology name="tiktoken" purpose="Token estimation for routing score"/>
    <technology name="FastAPI" purpose="Existing API for ops reporting"/>
    <technology name="PostgreSQL" purpose="Usage event storage with savings fields"/>
  </technology-stack>

  <configuration>
    <variable name="ROUTING_SIMPLE_MODEL" default="gpt-4o-mini"/>
    <variable name="ROUTING_MEDIUM_MODEL" default="gpt-4o"/>
    <variable name="ROUTING_COMPLEX_MODEL" default="gpt-4o"/>
    <variable name="ROUTING_BASELINE_MODEL" default="gpt-4o"/>
    <variable name="ROUTING_SIMPLE_MAX_SCORE" default="2"/>
    <variable name="ROUTING_COMPLEX_MIN_SCORE" default="5"/>
  </configuration>

  <implementation-notes>
    <note>
      Cache Agno agents per model_id inside the orchestrator to avoid per-request instantiation.
    </note>
    <note>
      Log routing decisions as trajectory ACTION events with complexity and score.
    </note>
    <note>
      Extend usage events to store baseline cost and savings for reporting.
    </note>
  </implementation-notes>

  <references>
    <reference path="_bmad-output/epics/epic-8-tech-spec.md"/>
    <reference path="_bmad-output/project-planning-artifacts/epics.md#story-82-intelligent-model-routing"/>
    <reference path="backend/src/agentic_rag_backend/ops/cost_tracker.py"/>
    <reference path="backend/src/agentic_rag_backend/agents/orchestrator.py"/>
  </references>
</story-context>
