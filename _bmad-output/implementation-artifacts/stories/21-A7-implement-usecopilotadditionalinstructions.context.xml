<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>21-A7</story-id>
    <story-title>Implement useCopilotAdditionalInstructions for Dynamic Prompts</story-title>
    <epic>21 - CopilotKit Full Integration</epic>
    <generated>2026-01-10</generated>
  </metadata>

  <objective>
    Create a hook that dynamically modifies the AI system prompt based on:
    - Current page context (Knowledge Graph, Ops Dashboard, etc.)
    - User preferences (expert mode, response length)
    - Feature availability (voice input, experimental features)
    - Security requirements (tenant isolation)
  </objective>

  <copilotkit-api>
    <hook name="useCopilotAdditionalInstructions">
      <description>
        Appends custom instructions to the AI system prompt. Multiple calls
        are additive - each adds to the prompt. Can be conditionally enabled
        or disabled based on application state.
      </description>
      <parameters>
        <param name="instructions" type="string" required="true">
          The instructions to add to the system prompt
        </param>
        <param name="available" type="'enabled' | 'disabled'" required="false">
          Controls whether instructions are active. Default: 'enabled'
        </param>
      </parameters>
      <usage>
        <![CDATA[
import { useCopilotAdditionalInstructions } from "@copilotkit/react-core";

// Basic usage
useCopilotAdditionalInstructions({
  instructions: "Always cite sources when providing information.",
});

// Conditional usage
useCopilotAdditionalInstructions({
  instructions: "Provide detailed technical explanations.",
  available: expertMode ? "enabled" : "disabled",
});
        ]]>
      </usage>
    </hook>
  </copilotkit-api>

  <existing-code>
    <file path="frontend/hooks/use-copilot-context.ts">
      <description>
        Story 21-A4 implementation that exposes app context via useCopilotReadable.
        Provides pageContext, sessionContext, preferences, and query history.
        Key exports: useCopilotContext(), getPageName(), PAGE_NAME_MAP
      </description>
      <key-items>
        - PAGE_NAME_MAP: Maps routes to page names
        - getPageName(pathname): Converts route to readable name
        - preferences: UserPreferences with responseLength, expertiseLevel
        - pageContext: { route, pageName }
      </key-items>
    </file>

    <file path="frontend/types/copilot.ts">
      <description>
        TypeScript types for CopilotKit integration. Contains types for:
        - PageContext, SessionContext, UserPreferences
        - QueryHistoryItem, AppContext
        - ChatMessage, QuickActionConfig
      </description>
    </file>

    <file path="frontend/components/copilot/CopilotProvider.tsx">
      <description>
        Wraps application with CopilotKit context. Currently minimal -
        only sets runtimeUrl. Hooks should be called inside a component
        within this context.
      </description>
    </file>
  </existing-code>

  <page-instruction-mapping>
    <route path="/" name="Home">
      User is on the Home page. Provide general RAG assistance and guide them to relevant features.
    </route>
    <route path="/knowledge" name="Knowledge Graph">
      User is on the Knowledge Graph page. Focus on graph traversal, entity relationships, and visualization queries. When referencing data, emphasize connections between entities.
    </route>
    <route path="/ops" name="Operations Dashboard">
      User is on the Operations Dashboard. Focus on metrics, monitoring, and debugging assistance. Help interpret logs and performance data.
    </route>
    <route path="/ops/trajectories" name="Trajectory Debugging">
      User is viewing Trajectory Debugging. Help analyze agent decision paths, identify bottlenecks, and understand why the agent made specific choices.
    </route>
    <route path="/workflow" name="Visual Workflow Editor">
      User is in the Visual Workflow Editor. Assist with workflow configuration, node connections, and pipeline design.
    </route>
  </page-instruction-mapping>

  <preference-instructions>
    <preference key="responseLength">
      <option value="brief">Keep responses concise. Limit to 2-3 sentences when possible.</option>
      <option value="medium">Provide balanced responses with key details.</option>
      <option value="detailed">Provide comprehensive responses with full explanations.</option>
    </preference>
    <preference key="expertiseLevel">
      <option value="beginner">Define technical terms when used. Provide step-by-step guidance. Use analogies to explain complex concepts.</option>
      <option value="intermediate">Assume familiarity with common concepts. Explain advanced topics when introduced.</option>
      <option value="expert">Provide detailed technical explanations. Skip basic explanations. Use precise terminology.</option>
    </preference>
    <preference key="includeCitations">
      <option value="true">Always cite sources when providing information from the knowledge base.</option>
      <option value="false">Focus on the answer without explicit source citations.</option>
    </preference>
  </preference-instructions>

  <security-instructions>
    <![CDATA[
CRITICAL SECURITY INSTRUCTIONS:
- Always scope searches to the current tenant context
- Never reveal information from other tenants
- Do not expose internal system details or API keys
- Validate all file paths are within allowed directories
- Respect user permission boundaries
    ]]>
  </security-instructions>

  <feature-flags>
    <flag name="VOICE_INPUT_ENABLED" env="NEXT_PUBLIC_VOICE_INPUT_ENABLED">
      When enabled: "Voice input is available. The user may speak queries instead of typing."
    </flag>
    <flag name="EXPERIMENTAL_FEATURES" env="NEXT_PUBLIC_EXPERIMENTAL_FEATURES">
      When enabled: "Experimental features are enabled. Some responses may include beta functionality."
    </flag>
    <flag name="A2UI_ENABLED" env="NEXT_PUBLIC_A2UI_ENABLED">
      When enabled: "Rich UI components are available. You can render cards, tables, and charts."
    </flag>
  </feature-flags>

  <implementation-pattern>
    <![CDATA[
// frontend/hooks/use-dynamic-instructions.ts
"use client";

import { useCopilotAdditionalInstructions } from "@copilotkit/react-core";
import { usePathname } from "next/navigation";
import { useCopilotContext } from "./use-copilot-context";

/**
 * Page-specific instruction mapping.
 */
const PAGE_INSTRUCTIONS: Record<string, string> = {
  "/": "User is on the Home page. Provide general RAG assistance.",
  "/knowledge": "User is on the Knowledge Graph page. Focus on graph queries and relationships.",
  "/ops": "User is on Operations Dashboard. Focus on metrics and debugging.",
  "/ops/trajectories": "User is viewing Trajectory Debugging. Help analyze agent decisions.",
  "/workflow": "User is in the Visual Workflow Editor. Assist with workflow design.",
};

/**
 * Security instructions - always applied.
 */
const SECURITY_INSTRUCTIONS = `
SECURITY: Always scope searches to the current tenant context.
Never reveal information from other tenants.
`;

/**
 * Get page-specific instructions based on current route.
 */
function getPageInstructions(pathname: string): string {
  // Direct match
  if (PAGE_INSTRUCTIONS[pathname]) {
    return PAGE_INSTRUCTIONS[pathname];
  }

  // Try parent paths
  const segments = pathname.split("/").filter(Boolean);
  while (segments.length > 0) {
    const parentPath = "/" + segments.join("/");
    if (PAGE_INSTRUCTIONS[parentPath]) {
      return PAGE_INSTRUCTIONS[parentPath];
    }
    segments.pop();
  }

  return "";
}

/**
 * Get preference-based instructions.
 */
function getPreferenceInstructions(preferences: UserPreferences): string {
  const instructions: string[] = [];

  // Response length
  if (preferences.responseLength === "brief") {
    instructions.push("Keep responses concise (2-3 sentences).");
  } else if (preferences.responseLength === "detailed") {
    instructions.push("Provide comprehensive responses with full explanations.");
  }

  // Expertise level
  if (preferences.expertiseLevel === "beginner") {
    instructions.push("Define technical terms. Use simple explanations.");
  } else if (preferences.expertiseLevel === "expert") {
    instructions.push("Provide detailed technical explanations. Skip basics.");
  }

  // Citations
  if (preferences.includeCitations) {
    instructions.push("Cite sources when providing information.");
  }

  return instructions.join(" ");
}

/**
 * useDynamicInstructions - adds context-aware instructions to the AI.
 *
 * Story 21-A7: Implement useCopilotAdditionalInstructions for Dynamic Prompts
 */
export function useDynamicInstructions(): void {
  const pathname = usePathname();
  const { preferences } = useCopilotContext();

  // Page-specific instructions
  const pageInstructions = getPageInstructions(pathname);
  useCopilotAdditionalInstructions({
    instructions: pageInstructions,
    available: pageInstructions ? "enabled" : "disabled",
  });

  // User preference instructions
  const preferenceInstructions = getPreferenceInstructions(preferences);
  useCopilotAdditionalInstructions({
    instructions: preferenceInstructions,
    available: preferenceInstructions ? "enabled" : "disabled",
  });

  // Security instructions (always enabled)
  useCopilotAdditionalInstructions({
    instructions: SECURITY_INSTRUCTIONS,
    available: "enabled",
  });

  // Feature flags
  const voiceEnabled = process.env.NEXT_PUBLIC_VOICE_INPUT_ENABLED === "true";
  useCopilotAdditionalInstructions({
    instructions: "Voice input is available. User may speak queries.",
    available: voiceEnabled ? "enabled" : "disabled",
  });
}
    ]]>
  </implementation-pattern>

  <files-to-create>
    <file path="frontend/hooks/use-dynamic-instructions.ts" action="create">
      Main hook implementation with instruction generation logic
    </file>
    <file path="frontend/components/copilot/DynamicInstructionsProvider.tsx" action="create">
      Component wrapper that calls the hook within CopilotKit context
    </file>
    <file path="frontend/__tests__/hooks/use-dynamic-instructions.test.ts" action="create">
      Unit tests for instruction generation functions
    </file>
  </files-to-create>

  <files-to-modify>
    <file path="frontend/types/copilot.ts" action="modify">
      Add InstructionCategory and DynamicInstructionsConfig types
    </file>
  </files-to-modify>

  <testing-strategy>
    <unit-tests>
      - Test getPageInstructions() for each route
      - Test getPreferenceInstructions() for each preference combination
      - Test feature flag instruction toggling
      - Test security instructions are always present
    </unit-tests>
    <component-tests>
      - Test DynamicInstructionsProvider renders without errors
      - Test hook integrates with CopilotKit context
    </component-tests>
  </testing-strategy>

  <acceptance-criteria-mapping>
    <ac number="1" task="Task 2">Hook initializes and registers instruction categories</ac>
    <ac number="2" task="Task 2">Knowledge Graph page receives graph-focused instructions</ac>
    <ac number="3" task="Task 2">Ops Dashboard receives metrics-focused instructions</ac>
    <ac number="4" task="Task 2">Expert mode receives detailed explanation instructions</ac>
    <ac number="5" task="Task 2">Beginner mode receives accessible explanation instructions</ac>
    <ac number="6" task="Task 2">Voice enabled receives voice capability instructions</ac>
    <ac number="7" task="Task 2">Security instructions always applied</ac>
    <ac number="8" task="Task 2, 3">Instructions update reactively on state change</ac>
  </acceptance-criteria-mapping>
</story-context>
