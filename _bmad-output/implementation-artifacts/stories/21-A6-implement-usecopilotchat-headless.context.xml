<?xml version="1.0" encoding="UTF-8"?>
<!--
  Story Context File: 21-A6-implement-usecopilotchat-headless
  Epic: 21 - CopilotKit Full Integration
  Generated: 2026-01-10

  This context file provides essential information for implementing
  the useCopilotChat headless control hook.
-->
<story-context>
  <story-metadata>
    <id>21-A6</id>
    <title>Implement useCopilotChat for Headless Control</title>
    <epic>21</epic>
    <group>A - Modern Hook Migration</group>
    <status>in-progress</status>
    <priority>P2 - LOW</priority>
    <story-points>3</story-points>
  </story-metadata>

  <objective>
    Enable programmatic chat control for testing, automation, and custom UIs
    by wrapping CopilotKit's useCopilotChat hook with convenient methods.
  </objective>

  <key-deliverables>
    <deliverable>useProgrammaticChat hook with wrapper methods</deliverable>
    <deliverable>QuickActions component for preset messages</deliverable>
    <deliverable>Types for programmatic chat operations</deliverable>
    <deliverable>Unit tests for hook and component</deliverable>
  </key-deliverables>

  <technical-context>
    <copilotkit-api>
      <hook-name>useCopilotChat</hook-name>
      <import-source>@copilotkit/react-core</import-source>
      <message-types-source>@copilotkit/runtime-client-gql</message-types-source>

      <return-values>
        <value name="visibleMessages" type="DeprecatedGqlMessage[]" description="Array of messages in conversation"/>
        <value name="appendMessage" type="function" description="Send new message programmatically"/>
        <value name="reloadMessages" type="function" description="Regenerate response for message by ID"/>
        <value name="stopGeneration" type="function" description="Cancel ongoing generation"/>
        <value name="reset" type="function" description="Clear all messages and reset state"/>
        <value name="isLoading" type="boolean" description="Whether chat is generating"/>
        <value name="runChatCompletion" type="function" description="Manually trigger completion"/>
      </return-values>

      <message-creation>
        <class name="TextMessage" import-from="@copilotkit/runtime-client-gql">
          <property name="role" type="MessageRole" required="true"/>
          <property name="content" type="string" required="true"/>
        </class>
        <enum name="MessageRole" values="User, Assistant, System"/>
      </message-creation>
    </copilotkit-api>

    <existing-patterns>
      <pattern name="hook-structure">
        See: frontend/hooks/use-copilot-context.ts for hook pattern
        - "use client" directive
        - JSDoc documentation
        - TypeScript interfaces
        - Error handling
      </pattern>
      <pattern name="component-structure">
        See: frontend/components/copilot/GenerativeUIRenderer.tsx
        - Props interface definition
        - JSDoc with @example
        - Callback handling
      </pattern>
      <pattern name="test-structure">
        See: frontend/__tests__/hooks/use-copilot-context.test.ts
        - Mock CopilotKit before imports
        - Mock Next.js navigation
        - Test utility functions directly
        - Avoid testing hook integration (ESM issues)
      </pattern>
    </existing-patterns>

    <file-locations>
      <create path="frontend/hooks/use-programmatic-chat.ts" purpose="Main hook"/>
      <create path="frontend/components/copilot/QuickActions.tsx" purpose="Quick action buttons"/>
      <create path="frontend/__tests__/hooks/use-programmatic-chat.test.ts" purpose="Hook tests"/>
      <create path="frontend/__tests__/components/QuickActions.test.tsx" purpose="Component tests"/>
      <modify path="frontend/types/copilot.ts" purpose="Add types"/>
    </file-locations>
  </technical-context>

  <implementation-requirements>
    <requirement priority="high">
      Wrap useCopilotChat with convenient methods:
      - sendMessage(content: string) - Send user message
      - regenerateLastResponse() - Regenerate last AI response
      - clearHistory() - Reset conversation
      - stopGeneration() - Cancel generation
    </requirement>

    <requirement priority="high">
      Create QuickActions component with preset buttons:
      - Summarize current document
      - Extract key insights
      - Find related topics
      - Buttons disabled during loading
    </requirement>

    <requirement priority="medium">
      Add types to copilot.ts:
      - ChatMessage interface
      - ProgrammaticChatReturn interface
      - QuickActionConfig interface
    </requirement>

    <requirement priority="medium">
      Error handling:
      - All async operations in try/catch
      - Console logging for debugging
      - Graceful degradation on failure
    </requirement>
  </implementation-requirements>

  <acceptance-criteria>
    <criterion id="1">Hook exposes convenient wrapper methods</criterion>
    <criterion id="2">sendMessage sends user message and triggers AI response</criterion>
    <criterion id="3">regenerateLastResponse reloads last message</criterion>
    <criterion id="4">stopGeneration cancels ongoing generation</criterion>
    <criterion id="5">clearHistory resets all messages</criterion>
    <criterion id="6">messageCount returns visible message count</criterion>
    <criterion id="7">Errors are logged and handled gracefully</criterion>
    <criterion id="8">QuickActions component sends preset messages</criterion>
  </acceptance-criteria>

  <testing-guidance>
    <note>
      Due to CopilotKit ESM dependencies, tests should:
      1. Mock @copilotkit/react-core before any imports
      2. Mock @copilotkit/runtime-client-gql before any imports
      3. Test utility functions directly (not hook integration)
      4. Test component rendering with mocked hook
    </note>

    <test-cases>
      <case name="sendMessage validates non-empty content"/>
      <case name="sendMessage creates TextMessage correctly"/>
      <case name="regenerateLastResponse finds correct message"/>
      <case name="clearHistory calls reset"/>
      <case name="messageCount returns array length"/>
      <case name="QuickActions renders all buttons"/>
      <case name="QuickActions disables buttons when loading"/>
      <case name="QuickActions calls sendMessage on click"/>
    </test-cases>
  </testing-guidance>

  <related-stories>
    <story id="21-A4" status="done">useCopilotReadable context - similar pattern</story>
    <story id="21-A5" status="backlog">useCopilotChatSuggestions - complementary feature</story>
    <story id="6-3" status="done">Generative UI - uses similar component patterns</story>
  </related-stories>

  <conventions>
    <naming>
      <hook>useProgrammaticChat</hook>
      <component>QuickActions</component>
      <types>PascalCase for interfaces</types>
      <files>kebab-case for file names</files>
    </naming>
    <imports>
      <note>Use @/ alias for frontend imports</note>
      <note>Import types with 'type' keyword</note>
    </imports>
    <documentation>
      <note>JSDoc on all exported functions</note>
      <note>@example blocks for usage</note>
    </documentation>
  </conventions>
</story-context>
